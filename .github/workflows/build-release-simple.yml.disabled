name: Build and Release APK (Simple)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.5'
          channel: 'stable'
          cache: true
      
      - name: Create local.properties
        run: |
          echo "ðŸ”§ Creating local.properties with Flutter SDK path..."
          cat > android/local.properties << EOF
          flutter.sdk=$FLUTTER_ROOT
          sdk.dir=$ANDROID_HOME
          EOF
          echo "âœ… local.properties created"
          cat android/local.properties
      
      - name: Install dependencies
        run: flutter pub get
      
      - name: Setup Android Signing
        run: |
          echo "ðŸ” Setting up Android signing..."
          echo "ðŸ“‹ Decoding keystore from GitHub secret..."
          
          # Create keystore
          mkdir -p android/app
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > android/app/upload-keystore.jks
          
          # Verify keystore was created
          if [ ! -f android/app/upload-keystore.jks ]; then
            echo "âŒ Failed to create keystore!"
            exit 1
          fi
          
          KEYSTORE_SIZE=$(stat -f%z android/app/upload-keystore.jks 2>/dev/null || stat -c%s android/app/upload-keystore.jks 2>/dev/null)
          echo "âœ… Keystore created: $KEYSTORE_SIZE bytes"
          ls -lh android/app/upload-keystore.jks
          
          # Create key.properties
          cat > android/key.properties << 'EOF'
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          storeFile=android/app/upload-keystore.jks
          EOF
          
          echo "âœ… key.properties created"
          echo "ðŸ“„ key.properties content:"
          cat android/key.properties
          
          # Verify all files exist
          echo ""
          echo "ðŸ“Š File verification:"
          echo "  Working directory: $(pwd)"
          echo "  android/ contents:"
          ls -la android/ | head -20
          echo ""
          echo "  android/app/ contents:"
          ls -la android/app/ | grep -E "jks|build\.gradle" || true
          
          # Test keystore file
          echo ""
          echo "ðŸ“Š Keystore verification:"
          file android/app/upload-keystore.jks || echo "file command not available"
          md5sum android/app/upload-keystore.jks || echo "md5sum not available"
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
      
      - name: Verify Build Configuration
        run: |
          echo "ðŸ” Verifying build.gradle configuration..."
          echo ""
          echo "ðŸ“„ android/build.gradle:"
          cat android/build.gradle
          echo ""
          echo "ðŸ“„ android/app/build.gradle (signingConfigs section):"
          grep -A 30 "signingConfigs" android/app/build.gradle || echo "No signingConfigs found"
          echo ""
          echo "ðŸ“„ android/gradle.properties:"
          cat android/gradle.properties || echo "No gradle.properties"
      
      - name: Clean Build
        run: |
          echo "ðŸ§¹ Cleaning previous builds..."
          flutter clean
          rm -rf build/
          rm -rf android/.gradle
          rm -rf android/app/build
          echo "âœ… Clean completed"
      
      - name: Build APK with Verbose Logging
        run: |
          echo "ðŸ—ï¸ Building APK with verbose logging..."
          echo "Flutter version:"
          flutter --version
          echo ""
          echo "Java version:"
          java -version
          echo ""
          echo "Starting build..."
          
          # Build with maximum verbosity
          flutter build apk --release -v --verbose 2>&1 | tee build.log
          BUILD_EXIT_CODE=${PIPESTATUS[0]}
          
          if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âŒ BUILD FAILED with exit code: $BUILD_EXIT_CODE"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "ðŸ“‹ LAST 150 LINES OF BUILD LOG:"
            tail -150 build.log
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸ” ERRORS AND FAILURES:"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            grep -iE "error|fail|exception" build.log | tail -50 || echo "No error keywords found"
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸ” GRADLE SPECIFIC ERRORS:"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            grep -iE "gradle|assembleRelease|task.*failed" build.log | tail -30 || echo "No Gradle errors found"
            exit 1
          fi
          
          echo "âœ… Build completed successfully"
          ls -lh build/app/outputs/flutter-apk/
      
      - name: Get version
        id: version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | cut -d '+' -f1)
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.VERSION }}
          name: EC Saver v${{ steps.version.outputs.VERSION }}
          body: |
            ## EC Saver v${{ steps.version.outputs.VERSION }}
            
            Download and install the APK below.
            
            **Installation:** Enable "Install from Unknown Sources" in Android settings.
          files: build/app/outputs/flutter-apk/app-release.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
