name: Build and Release Flutter App

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.16)'
        required: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Get version from tag or pubspec
        id: version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
            echo "ğŸ“¦ Building from tag: v$VERSION"
          elif [[ -n "${{ github.event.inputs.version }}" ]]; then
            VERSION="${{ github.event.inputs.version }}"
            echo "ğŸ“¦ Building from manual input: $VERSION"
          else
            VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | cut -d '+' -f1)
            echo "ğŸ“¦ Building from pubspec.yaml: $VERSION"
          fi

          # Extract build number if present
          if [[ "$VERSION" == *"+"* ]]; then
            BUILD=$(echo "$VERSION" | cut -d '+' -f2)
            VERSION=$(echo "$VERSION" | cut -d '+' -f1)
          else
            # Get build from pubspec.yaml
            BUILD=$(grep '^version:' pubspec.yaml | sed 's/version: //' | cut -d '+' -f2)
            if [[ -z "$BUILD" || ! "$BUILD" =~ ^[0-9]+$ ]]; then
              BUILD="1"
            fi
          fi

          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "BUILD=$BUILD" >> $GITHUB_OUTPUT
          echo "ğŸ—ï¸ Building version: $VERSION (build $BUILD)"

          # Update pubspec.yaml
          sed -i "s/^version:.*/version: $VERSION+$BUILD/" pubspec.yaml
          cat pubspec.yaml | grep "^version:"

      - name: Create local.properties
        run: |
          echo "ğŸ”§ Creating local.properties..."
          cat > android/local.properties << EOF
          flutter.sdk=$FLUTTER_ROOT
          sdk.dir=$ANDROID_HOME
          flutter.versionCode=${{ steps.version.outputs.BUILD }}
          flutter.versionName=${{ steps.version.outputs.VERSION }}
          flutter.minSdkVersion=24
          EOF
          echo "âœ… local.properties created"
          cat android/local.properties

      - name: Install dependencies
        run: flutter pub get

      - name: Setup Android Signing
        run: |
          echo "ğŸ” Setting up Android signing..."
          mkdir -p android/app
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > android/app/upload-keystore.jks

          if [ ! -f android/app/upload-keystore.jks ]; then
            echo "âŒ Failed to create keystore!"
            exit 1
          fi

          KEYSTORE_SIZE=$(stat -c%s android/app/upload-keystore.jks 2>/dev/null || stat -f%z android/app/upload-keystore.jks 2>/dev/null)
          echo "âœ… Keystore created: $KEYSTORE_SIZE bytes"

          # Create key.properties
          cat > android/key.properties << 'EOF'
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          storeFile=android/app/upload-keystore.jks
          EOF

          echo "âœ… key.properties created"
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}

      - name: Clean Build
        run: |
          echo "ğŸ§¹ Cleaning previous builds..."
          flutter clean
          rm -rf build/
          rm -rf android/.gradle
          rm -rf android/app/build
          # Ensure Gradle wrapper uses our pinned version (8.5.2)
          rm -rf ~/.gradle/wrapper/dists
          echo "âœ… Clean completed"

      - name: Build APK
        run: |
          echo "ğŸ—ï¸ Building APK..."
          flutter --version
          java -version

          flutter build apk --release --verbose 2>&1 | tee build.log
          BUILD_EXIT_CODE=${PIPESTATUS[0]}

          if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo "âŒ BUILD FAILED with exit code: $BUILD_EXIT_CODE"
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“‹ LAST 100 LINES OF BUILD LOG:"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            tail -100 build.log
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ” ERRORS:"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            grep -iE \"error|fail|exception\" build.log | tail -30 || echo \"No errors found\"
            exit 1
          fi

          echo "âœ… Build completed successfully"
          ls -lh build/app/outputs/flutter-apk/

      - name: Verify APK
        run: |
          if [ ! -f \"build/app/outputs/flutter-apk/app-release.apk\" ]; then
            echo \"âŒ APK file not found!\"
            ls -la build/app/outputs/flutter-apk/
            exit 1
          fi
          echo \"âœ… APK file found\"
          ls -lh build/app/outputs/flutter-apk/app-release.apk

      - name: Rename APK
        run: |
          cp build/app/outputs/flutter-apk/app-release.apk \
             build/app/outputs/flutter-apk/ec-saver-v${{ steps.version.outputs.VERSION }}-release.apk
          echo \"âœ… APK renamed to ec-saver-v${{ steps.version.outputs.VERSION }}-release.apk\"
          ls -lh build/app/outputs/flutter-apk/ec-saver-*.apk

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.VERSION }}
          name: EC Saver v${{ steps.version.outputs.VERSION }}
          body: |
            ## ğŸš€ EC Saver v${{ steps.version.outputs.VERSION }}

            ### ğŸ“¥ Download
            Download `ec-saver-v${{ steps.version.outputs.VERSION }}-release.apk` below.

            ### âš™ï¸ Installation
            1. Download the APK
            2. Enable "Install from Unknown Sources" in Android settings
            3. Install and enjoy!

            ### ğŸ“‹ Requirements
            - Android 5.0 (Lollipop) or higher

            ### âš ï¸ Important
            - Uninstall old version first if upgrading
            - All data is stored locally on your device

            ---
            **Version:** ${{ steps.version.outputs.VERSION }}+${{ steps.version.outputs.BUILD }}
            **Built with:** Flutter stable | Designed by NexiVault
          draft: false
          prerelease: false
          files: |
            build/app/outputs/flutter-apk/ec-saver-v${{ steps.version.outputs.VERSION }}-release.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
